rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================

    // Check if request is from authenticated user
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get user document
    function getUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Get user's company ID
    function getUserCompanyId() {
      return getUser().companyId;
    }

    // Get user's role document
    function getUserRole() {
      let user = getUser();
      return get(/databases/$(database)/documents/companies/$(user.companyId)/roles/$(user.roleId)).data;
    }

    // Check if user belongs to a company
    function belongsToCompany(companyId) {
      return isAuthenticated() && getUserCompanyId() == companyId;
    }

    // Check if user has a specific permission
    function hasPermission(permission) {
      return getUserRole().permissions[permission] == true;
    }

    // Check if user has any of the listed permissions
    function hasAnyPermission(permissions) {
      let role = getUserRole();
      return permissions.size() > 0 && (
        (permissions.size() >= 1 && role.permissions[permissions[0]] == true) ||
        (permissions.size() >= 2 && role.permissions[permissions[1]] == true) ||
        (permissions.size() >= 3 && role.permissions[permissions[2]] == true)
      );
    }

    // Check if user is company owner
    function isCompanyOwner(companyId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/companies/$(companyId)).data.ownerUserId == request.auth.uid;
    }

    // Check if resource belongs to user's company
    function resourceBelongsToUserCompany() {
      return resource.data.companyId == getUserCompanyId();
    }

    // Check if new data belongs to user's company
    function newDataBelongsToUserCompany() {
      return request.resource.data.companyId == getUserCompanyId();
    }

    // Validate data has required fields
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Check if user is active
    function isActiveUser() {
      return getUser().status == 'active';
    }

    // ============================================================
    // COMPANIES
    // ============================================================

    match /companies/{companyId} {
      // Read: company members only
      allow read: if belongsToCompany(companyId);

      // Create: authenticated users (during signup)
      allow create: if isAuthenticated()
        && request.resource.data.ownerUserId == request.auth.uid;

      // Update: company owner or users with company.settings permission
      allow update: if belongsToCompany(companyId)
        && (isCompanyOwner(companyId) || hasPermission('company.settings'));

      // Delete: never (companies are deactivated, not deleted)
      allow delete: if false;

      // ==================== ROLES SUBCOLLECTION ====================
      match /roles/{roleId} {
        // Read: company members
        allow read: if belongsToCompany(companyId);

        // Write: company owner or users with roles.manage permission
        allow create, update: if belongsToCompany(companyId)
          && (isCompanyOwner(companyId) || hasPermission('roles.manage'));

        // Delete: only non-system roles, by owner or roles.manage
        allow delete: if belongsToCompany(companyId)
          && resource.data.isSystemRole != true
          && (isCompanyOwner(companyId) || hasPermission('roles.manage'));
      }

      // ==================== TIME ENTRIES SUBCOLLECTION ====================
      match /timeEntries/{entryId} {
        // Helper: is this user's own time entry?
        function isOwnTimeEntry() {
          return resource.data.userId == request.auth.uid;
        }

        // Read: own entries OR view all permission
        allow read: if belongsToCompany(companyId)
          && (isOwnTimeEntry() || hasPermission('timeclock.view.all'));

        // Create: user can clock themselves in (timeclock.own)
        allow create: if belongsToCompany(companyId)
          && hasPermission('timeclock.own')
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.companyId == companyId;

        // Update own entry (clock out, add breaks)
        allow update: if belongsToCompany(companyId)
          && isOwnTimeEntry()
          && hasPermission('timeclock.own')
          && !request.resource.data.diff(resource.data).affectedKeys()
              .hasAny(['userId', 'companyId', 'status']);

        // Update any entry (managers with timeclock.manage)
        allow update: if belongsToCompany(companyId)
          && hasPermission('timeclock.manage');

        // Delete: only managers with timeclock.manage
        allow delete: if belongsToCompany(companyId)
          && hasPermission('timeclock.manage');
      }
    }

    // ============================================================
    // USERS
    // ============================================================

    match /users/{userId} {
      // Read own data always
      allow read: if isOwner(userId);

      // Read company members: if same company and has team.view permission
      allow read: if isAuthenticated()
        && resource.data.companyId == getUserCompanyId()
        && hasPermission('team.view');

      // Create own user during signup
      allow create: if isOwner(userId);

      // Update own profile fields
      allow update: if isOwner(userId)
        && (!request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['companyId', 'roleId', 'status']));

      // Update by team manager: role, team assignment, status
      allow update: if isAuthenticated()
        && resource.data.companyId == getUserCompanyId()
        && hasPermission('team.edit')
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['companyId']);

      // Delete: soft delete only (status change), by team.remove permission
      allow delete: if false; // Use status = 'deleted' instead

      // ==================== EXAM PROGRESS SUBCOLLECTION ====================
      match /examProgress/{topicId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }

      // ==================== CALCULATION HISTORY SUBCOLLECTION ====================
      match /calculationHistory/{calcId} {
        allow read: if isOwner(userId);
        allow create, update, delete: if isOwner(userId);
      }

      // ==================== FAVORITES SUBCOLLECTION ====================
      match /favorites/{screenId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }

    // ============================================================
    // JOBS
    // ============================================================

    match /jobs/{jobId} {
      // Helper: is user assigned to this job?
      function isAssignedToJob() {
        return resource.data.assignedToUserId == request.auth.uid
          || (resource.data.assignedUserIds != null
              && request.auth.uid in resource.data.assignedUserIds);
      }

      function isAssignedToNewJob() {
        return request.resource.data.assignedToUserId == request.auth.uid
          || (request.resource.data.assignedUserIds != null
              && request.auth.uid in request.resource.data.assignedUserIds);
      }

      // Read: view all OR (view own AND assigned)
      allow read: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && (hasPermission('jobs.view.all')
            || (hasPermission('jobs.view.own') && isAssignedToJob()));

      // Create: jobs.create permission
      allow create: if isAuthenticated()
        && newDataBelongsToUserCompany()
        && hasPermission('jobs.create')
        && request.resource.data.createdByUserId == request.auth.uid;

      // Update: edit all OR (edit own AND assigned)
      allow update: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && newDataBelongsToUserCompany()
        && (hasPermission('jobs.edit.all')
            || (hasPermission('jobs.edit.own') && isAssignedToJob()));

      // Delete: jobs.delete permission
      allow delete: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && hasPermission('jobs.delete');

      // ==================== JOB PHOTOS SUBCOLLECTION ====================
      match /photos/{photoId} {
        allow read: if isAuthenticated()
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.companyId == getUserCompanyId();
        allow create, update: if isAuthenticated()
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.companyId == getUserCompanyId()
          && hasAnyPermission(['jobs.edit.own', 'jobs.edit.all']);
        allow delete: if isAuthenticated()
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.companyId == getUserCompanyId()
          && hasPermission('jobs.delete');
      }

      // ==================== JOB TIME ENTRIES SUBCOLLECTION ====================
      match /timeEntries/{entryId} {
        allow read: if isAuthenticated()
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.companyId == getUserCompanyId();
        allow create: if isAuthenticated()
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.companyId == getUserCompanyId()
          && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated()
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.companyId == getUserCompanyId()
          && (resource.data.userId == request.auth.uid || hasPermission('jobs.edit.all'));
      }
    }

    // ============================================================
    // CUSTOMERS
    // ============================================================

    match /customers/{customerId} {
      // Read: customers.view permission
      allow read: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && hasPermission('customers.view');

      // Create: customers.create permission
      allow create: if isAuthenticated()
        && newDataBelongsToUserCompany()
        && hasPermission('customers.create');

      // Update: customers.edit permission
      allow update: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && newDataBelongsToUserCompany()
        && hasPermission('customers.edit');

      // Delete: customers.delete permission
      allow delete: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && hasPermission('customers.delete');
    }

    // ============================================================
    // INVOICES
    // ============================================================

    match /invoices/{invoiceId} {
      // Helper: did user create this invoice?
      function isInvoiceCreator() {
        return resource.data.createdByUserId == request.auth.uid;
      }

      // Read: view all OR (view own AND creator)
      allow read: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && (hasPermission('invoices.view.all')
            || (hasPermission('invoices.view.own') && isInvoiceCreator()));

      // Create: invoices.create permission
      allow create: if isAuthenticated()
        && newDataBelongsToUserCompany()
        && hasPermission('invoices.create')
        && request.resource.data.createdByUserId == request.auth.uid;

      // Update: invoices.edit OR (approve for status changes)
      allow update: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && newDataBelongsToUserCompany()
        && (hasPermission('invoices.edit')
            || (hasPermission('invoices.approve')
                && request.resource.data.diff(resource.data).affectedKeys()
                   .hasOnly(['status', 'approvedByUserId', 'approvedAt', 'updatedAt'])));

      // Delete/Void: invoices.void permission
      allow delete: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && hasPermission('invoices.void');
    }

    // ============================================================
    // TEAMS (Growing+ tiers)
    // ============================================================

    match /teams/{teamId} {
      // Read: team.view permission
      allow read: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && hasPermission('team.view');

      // Create/Update: company owner or team.edit
      allow create, update: if isAuthenticated()
        && newDataBelongsToUserCompany()
        && (isCompanyOwner(request.resource.data.companyId) || hasPermission('team.edit'));

      // Delete: company owner or team.remove
      allow delete: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && (isCompanyOwner(resource.data.companyId) || hasPermission('team.remove'));
    }

    // ============================================================
    // AUDIT LOGS (Enterprise tier)
    // ============================================================

    match /auditLogs/{logId} {
      // Read: audit.view permission
      allow read: if isAuthenticated()
        && resourceBelongsToUserCompany()
        && hasPermission('audit.view');

      // Write: only Cloud Functions
      allow write: if false;
    }

    // ============================================================
    // SCANS (AI Scanner)
    // ============================================================

    match /scans/{scanId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow write: if false; // Only Cloud Functions can write
    }

    // ============================================================
    // SYSTEM COLLECTIONS
    // ============================================================

    match /_health/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    match /_meta/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
  }
}
